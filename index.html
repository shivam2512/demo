<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Practice Session Notes + Assignments (CodeMirror)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
    .weekday { font-weight: 600; text-align: center; color: #495057; padding: 6px 0; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #e9ecef; }
    .calendar-day { border: 1px solid #dee2e6; padding: 12px; text-align: center; cursor: pointer; min-height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 0.6rem; background-color: #ffffff; transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease; font-weight: 500; }
    .calendar-day.has-notes { background: linear-gradient(135deg, #d1e7dd, #b6e0c2); color: #0f5132; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); border-color: #b6e0c2; }
    .calendar-day.today { background: linear-gradient(135deg, #fff3cd, #ffe69c); color: #664d03; border-color: #ffe69c; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.25); font-weight: 700; }
    .calendar-day:hover { transform: translateY(-2px); background: linear-gradient(135deg, #f8d7da, #f5c2c7); color: #842029; box-shadow: 0 6px 16px rgba(220, 53, 69, 0.25); border-color: #f5c2c7; }
    #calendarContainer .card { border: none; overflow: hidden; }
    @media (max-width: 576px) {
      .calendar { grid-template-columns: repeat(3, 1fr); }
      .weekday { font-size: 0.8rem; padding: 4px 0; }
      .calendar-day { min-height: 52px; font-size: 0.9rem; padding: 8px; }
      .btn { width: 100%; }
      .nav-controls h4 { font-size: 1rem; margin: 0 8px; }
    }

    /* Assignment styles */
    #assignmentSection { margin: 32px 0; }
    #codeEditor { height: 300px; border: 1px solid #ddd; border-radius: 4px; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; z-index:1050; display:none; background: rgba(0,0,0,0.4); }
    .modal .modal-dialog { margin: 6rem auto; }
    .text-truncate-multi { overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <span class="navbar-brand">Practice Session Notes</span>
      <button id="openAssignmentsBtn" class="btn btn-warning ms-3" onclick="document.getElementById('assignmentSection').scrollIntoView({behavior:'smooth'})">Assignments</button>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <button id="adminViewBtn" class="btn btn-outline-light" onclick="AssignmentModule.showAdminView()">Admin View</button>
      </div>
    </div>
  </nav>

  <div id="latestNotification" class="alert alert-info text-center mb-0">Latest notes: Loading‚Ä¶</div>

  <main class="container py-4">
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" onclick="downloadSQLFile('Afternoon','Afternoon.sql')">Download Afternoon Notes</button>
      <button class="btn btn-primary" onclick="downloadSQLFile('Evening','Evening.sql')">Download Evening Notes</button>
    </div>

    <div class="nav-controls d-flex justify-content-between align-items-center mb-2">
      <button class="btn btn-outline-secondary" onclick="prevMonth()">‚Üê Previous</button>
      <h4 id="monthLabel" class="fw-bold mb-0"></h4>
      <button class="btn btn-outline-secondary" onclick="nextMonth()">Next ‚Üí</button>
    </div>

    <div id="calendarContainer" class="mb-4"></div>
    <div id="notesContainer"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none"><h5>No notes yet</h5></div>
    <div class="text-center mt-3">
      <button class="btn btn-outline-secondary d-none" id="clearViewBtn" onclick="clearNotesView()">Clear View</button>
    </div>

    <hr class="my-4">
    <section id="assignmentSection">
      <h3>SQL Assignment</h3>

      <div id="studentDetailsCard" class="card p-3 mb-3">
        <h5 class="mb-2">Enter your details before starting</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <input id="studentName" class="form-control" placeholder="Full name">
          </div>
          <div class="col-md-6">
            <input id="studentMobile" class="form-control" placeholder="Mobile number">
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="startAssignmentBtn" class="btn btn-primary" onclick="AssignmentModule.start()">Start Assignment</button>
          <button id="clearStudentBtn" class="btn btn-outline-secondary" onclick="AssignmentModule.clearStudentDetails()">Clear</button>
        </div>
        <div class="form-text mt-2 text-muted">Students must fill details. After submitting, you cannot re-attempt (per browser).</div>
      </div>

      <div id="assignmentCard" class="card mb-3 d-none">
        <div class="card-body">
          <div id="assignmentTitle" class="h5"></div>
          <div id="assignmentQuestion" class="mb-3 text-muted"></div>

          <label class="form-label">SQL Editor</label>
          <!-- CodeMirror will mount here -->
          <div id="codeEditor"></div>
          <!-- fallback textarea (hidden unless CodeMirror fails) -->
          <div id="editorFallbackContainer" style="display:none; margin-top:8px;">
            <textarea id="assignmentEditorFallback" rows="10" class="form-control" placeholder="Type SQL here"></textarea>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button id="submitAssignmentBtn" class="btn btn-success" onclick="AssignmentModule.submit()">Submit</button>
            <button id="showSampleBtn" class="btn btn-outline-info" onclick="AssignmentModule.insertSample()">Show Sample</button>
            <button id="cancelAssignmentBtn" class="btn btn-outline-secondary" onclick="AssignmentModule.cancel()">Cancel</button>
          </div>

          <div id="assignmentResult" class="mt-3"></div>
        </div>
      </div>

      <div id="alreadySubmittedCard" class="alert alert-success d-none">You have already submitted this assignment. Thank you!</div>
    </section>

  </main>

  <div id="adminModal" class="modal" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5 class="modal-title">Submissions (Admin)</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="AssignmentModule.exportCSV()">Export CSV</button>
            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('adminModal').style.display='none'">Close</button>
          </div>
        </div>
        <div class="modal-body" id="adminModalBody"></div>
      </div>
    </div>
  </div>

  <!-- CodeMirror 6 via dynamic import (works in modern browsers) -->
  <script>
    // Create a global factory function to build the CodeMirror editor when needed.
    // Uses dynamic import so this file remains a normal script.
    window.createCodeMirrorEditor = async function (initialCode = '') {
      try {
        // dynamic imports
        const [{ EditorView, keymap }, { default: basicSetup }, { sql }, { oneDark }, { EditorState }] = await Promise.all([
          import('https://esm.sh/@codemirror/view@6.11.4'),
          import('https://esm.sh/@codemirror/basic-setup@0.19.1'),
          import('https://esm.sh/@codemirror/lang-sql@0.19.1'),
          import('https://esm.sh/@codemirror/theme-one-dark@0.19.5'),
          import('https://esm.sh/@codemirror/state@0.19.7')
        ]);

        // remove any previous editor content
        const mount = document.getElementById('codeEditor');
        mount.innerHTML = '';

        const state = EditorState.create({
          doc: initialCode,
          extensions: [
            basicSetup,
            sql(),
            oneDark,
            EditorView.editable.of(true)
          ]
        });

        // create view
        window.codeEditor = new EditorView({ state, parent: mount });

        // ensure visible & focused
        setTimeout(() => {
          try { window.codeEditor.focus(); } catch (e) {}
        }, 50);

        return window.codeEditor;
      } catch (err) {
        console.warn('CodeMirror init failed:', err);
        // fallback: show simple textarea
        const mount = document.getElementById('codeEditor');
        mount.innerHTML = '';
        document.getElementById('editorFallbackContainer').style.display = 'block';
        const ta = document.getElementById('assignmentEditorFallback');
        ta.value = initialCode || '';
        ta.focus();
        window.codeEditor = null; // signal fallback mode
        return null;
      }
    }
  </script>

  <script>
    /***********************
     Original notes/calendar (kept exactly)
    ***********************/
    let allNotes = [];
    let currentMonthIndex, currentYear;

    const monthMap = { JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06", JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12" };
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    function parseNoteDate(str){ const [d,mText,y] = str.split("-"); const mNum = Number(monthMap[mText.toUpperCase()]); return { day:d, monthNum:mNum, monthText:mText.toUpperCase(), year:y }; }
    function toJSDate(str){ const {day, monthNum, year} = parseNoteDate(str); return new Date(Number(year), monthNum-1, Number(day)); }

    async function loadNotes(){
      try {
        const res = await fetch("notes.json");
        const notes = await res.json();
        allNotes = notes;
        const today = new Date();
        currentMonthIndex = today.getMonth();
        currentYear = today.getFullYear();
        renderCalendar();
        updateLatestNotification();
      } catch(err){ console.error("Error loading notes:", err); document.getElementById("latestNotification").textContent = "Failed to load notes."; }
    }

    function renderCalendar(){
      const container = document.getElementById("calendarContainer"); container.innerHTML="";
      document.getElementById("monthLabel").textContent = `${monthNames[currentMonthIndex]} ${currentYear}`;
      const daysInMonth = new Date(currentYear, currentMonthIndex+1, 0).getDate();
      let firstDay = new Date(currentYear, currentMonthIndex,1).getDay(); firstDay = firstDay === 0 ? 7 : firstDay;
      const card = document.createElement("div"); card.className="card shadow-lg";
      const calendarBody = document.createElement("div"); calendarBody.className="card-body";
      const weekdays = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]; const weekdayRow = document.createElement("div"); weekdayRow.className="calendar";
      weekdays.forEach(w=>{ const wd=document.createElement("div"); wd.className="weekday"; wd.textContent=w; weekdayRow.appendChild(wd); });
      calendarBody.appendChild(weekdayRow);
      const calendar = document.createElement("div"); calendar.className="calendar";
      for(let i=1;i<firstDay;i++){ const emptyCell=document.createElement("div"); emptyCell.className="calendar-day"; calendar.appendChild(emptyCell); }
      const today = new Date();
      for(let d=1; d<=daysInMonth; d++){
        const dayStr=String(d).padStart(2,'0');
        const hasNote = allNotes.some(n=>{ const {day, monthNum, year} = parseNoteDate(n.date); return day===dayStr && monthNum=== currentMonthIndex+1 && Number(year)===currentYear; });
        const dayCell = document.createElement("div"); dayCell.className = "calendar-day" + (hasNote ? " has-notes": ""); dayCell.textContent = d;
        if(today.getMonth()===currentMonthIndex && today.getFullYear()===currentYear && today.getDate()===d) dayCell.classList.add("today");
        dayCell.addEventListener("click", ()=>{ const filtered = allNotes.filter(n=>{ const {day, monthNum, year} = parseNoteDate(n.date); return day===dayStr && monthNum=== currentMonthIndex+1 && Number(year)===currentYear; }); renderNotes(filtered); });
        calendar.appendChild(dayCell);
      }
      const totalCells = (firstDay-1) + daysInMonth; const trailing = (7 - (totalCells % 7)) % 7;
      for(let i=0;i<trailing;i++){ const emptyCell=document.createElement("div"); emptyCell.className="calendar-day"; calendar.appendChild(emptyCell); }
      calendarBody.appendChild(calendar); card.appendChild(calendarBody); container.appendChild(card);
    }

    function prevMonth(){ currentMonthIndex--; if(currentMonthIndex<0){ currentMonthIndex=11; currentYear--; } renderCalendar(); }
    function nextMonth(){ currentMonthIndex++; if(currentMonthIndex>11){ currentMonthIndex=0; currentYear++; } renderCalendar(); }

    function renderNotes(notes){
      const container = document.getElementById("notesContainer"); const emptyState = document.getElementById("emptyState"); const clearBtn = document.getElementById("clearViewBtn");
      container.innerHTML="";
      if(!notes.length){ emptyState.classList.remove("d-none"); clearBtn.classList.add("d-none"); return; }
      emptyState.classList.add("d-none");
      notes.forEach(n=>{ const card=document.createElement("div"); card.className="card mb-3 shadow-sm"; card.innerHTML = `<div class="card-header bg-success text-white"><strong>${n.date}</strong> ‚Äì ${n.session} ‚Äì ${n.title}</div><div class="card-body"><pre class="bg-light p-3 rounded"><code>${n.body}</code></pre></div>`; container.appendChild(card); });
      clearBtn.classList.remove("d-none");
    }

    function clearNotesView(){ document.getElementById("notesContainer").innerHTML=""; document.getElementById("emptyState").classList.add("d-none"); document.getElementById("clearViewBtn").classList.add("d-none"); }
    function downloadSQLFile(session, filename){ const sessionNotes = allNotes.filter(n=>n.session === session); const sqlContent = sessionNotes.map(n=>`-- ${n.date} : ${n.title}\n${n.body}\n\n`).join(""); const blob = new Blob([sqlContent], { type: "text/sql" }); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showNotification(`${filename} has been updated and downloaded!`); }
    function showNotification(message){ const notif=document.createElement("div"); notif.className="alert alert-success text-center"; notif.textContent=message; document.body.prepend(notif); setTimeout(()=>notif.remove(),5000); }
    function updateLatestNotification(){ if(!allNotes.length){ document.getElementById("latestNotification").textContent="No notes available yet."; return; } const sorted=[...allNotes].sort((a,b)=> toJSDate(b.date)-toJSDate(a.date)); const latestDate=sorted[0].date; const latestDayNotes = allNotes.filter(n=>n.date===latestDate); const latestNote = latestDayNotes.find(n=>n.session==='Evening') || latestDayNotes[0]; document.getElementById("latestNotification").textContent = `üîî Latest notes available: ${latestNote.date} (${latestNote.session} session, uploaded at ${latestNote.time})`; }

    // start notes load
    loadNotes();

    /***********************
     AssignmentModule (CodeMirror)
    ***********************/
    const AssignmentModule = (function(){
      const GS_SCRIPT_URL = ''; // put your Apps Script URL here if you want server POST
      const STORAGE_KEY_SUBMISSIONS = 'assign_submissions_v2';
      const STORAGE_KEY_STUDENT = 'assign_student_v2';
      const ASSIGNMENT = {
        id: 1,
        title: 'SQL Basics Assignment',
        question: `1) Create table EMP (ID INT, NAME TEXT, SALARY INT)\n2) Insert at least 3 rows\n3) Write a SELECT query to fetch employees with SALARY > 5000`,
        sample: `-- Example:\nCREATE TABLE EMP (ID INTEGER, NAME TEXT, SALARY INTEGER);\nINSERT INTO EMP VALUES (1,'Alice',6000);\nINSERT INTO EMP VALUES (2,'Bob',4500);\nINSERT INTO EMP VALUES (3,'Charlie',7000);\n\nSELECT * FROM EMP WHERE SALARY > 5000;`
      };

      let submissions = [];
      // codeEditor is created by createCodeMirrorEditor and stored on window.codeEditor
      function init(){
        try { submissions = JSON.parse(localStorage.getItem(STORAGE_KEY_SUBMISSIONS) || '[]'); } catch(e){ submissions = []; }
        const savedStudent = JSON.parse(localStorage.getItem(STORAGE_KEY_STUDENT) || 'null');
        if(savedStudent && savedStudent.name){
          document.getElementById('studentName').value = savedStudent.name || '';
          document.getElementById('studentMobile').value = savedStudent.mobile || '';
          if(hasSubmitted(savedStudent)) showAlreadySubmitted();
        }
      }

      function hasSubmitted(student){
        if(!student) return false;
        return submissions.some(s => s.name === student.name && s.mobile === student.mobile && s.assignmentId === ASSIGNMENT.id);
      }

      async function start(){
        const name = document.getElementById('studentName').value.trim();
        const mobile = document.getElementById('studentMobile').value.trim();
        if(!name || !mobile){ alert('Please enter name and mobile number before starting the assignment.'); return; }
        const student = { name, mobile };
        localStorage.setItem(STORAGE_KEY_STUDENT, JSON.stringify(student));
        if(hasSubmitted(student)){ showAlreadySubmitted(); return; }

        document.getElementById('studentDetailsCard').classList.add('d-none');
        document.getElementById('assignmentCard').classList.remove('d-none');
        document.getElementById('assignmentTitle').textContent = ASSIGNMENT.title;
        document.getElementById('assignmentQuestion').textContent = ASSIGNMENT.question;
        document.getElementById('assignmentResult').innerHTML = '';

        // create CodeMirror editor after visible
        setTimeout(async ()=> {
          await createCodeMirrorEditor(ASSIGNMENT.sample);
          // ensure editor focused
          setTimeout(()=>{ try { if(window.codeEditor) window.codeEditor.focus(); else document.getElementById('assignmentEditorFallback').focus(); } catch(e){} }, 120);
        }, 80);
      }

      function cancel(){
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('studentDetailsCard').classList.remove('d-none');
      }

      function clearStudentDetails(){
        localStorage.removeItem(STORAGE_KEY_STUDENT);
        document.getElementById('studentName').value = '';
        document.getElementById('studentMobile').value = '';
        document.getElementById('editorFallbackContainer').style.display = 'none';
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.add('d-none');
        document.getElementById('studentDetailsCard').classList.remove('d-none');
      }

      function gradeQuery(query){
        let score=0; const q = (query||'').toLowerCase();
        if(q.includes('select')) score+=30;
        if(q.includes('from')) score+=20;
        if(q.includes('where')) score+=20;
        if(q.includes('create')) score+=15;
        if(q.includes('insert')) score+=15;
        return Math.min(100, score);
      }

      async function submit(){
        const student = JSON.parse(localStorage.getItem(STORAGE_KEY_STUDENT) || 'null');
        if(!student || !student.name){ alert('Provide your details first'); return; }
        if(hasSubmitted(student)){ alert('You have already submitted this assignment.'); showAlreadySubmitted(); return; }

        // Get query from CodeMirror or fallback textarea
        let query = '';
        if(window.codeEditor && window.codeEditor.state){
          try { query = window.codeEditor.state.doc.toString().trim(); } catch(e){ query = ''; }
        } else {
          const ta = document.getElementById('assignmentEditorFallback');
          query = ta ? ta.value.trim() : '';
        }

        if(!query){ alert('Please write your SQL before submitting.'); return; }

        const score = gradeQuery(query);
        const entry = { assignmentId: ASSIGNMENT.id, name: student.name, mobile: student.mobile, query, score, submittedAt: new Date().toISOString() };
        submissions.unshift(entry);
        localStorage.setItem(STORAGE_KEY_SUBMISSIONS, JSON.stringify(submissions));

        document.getElementById('assignmentResult').innerHTML = `<div class="alert alert-info">Submitted! Score: <strong>${score}</strong>/100</div>`;
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.remove('d-none');

        if(GS_SCRIPT_URL && GS_SCRIPT_URL.trim()){
          try { await sendToServer(entry); } catch(e){ console.warn('Send to server failed', e); }
        }
      }

      async function sendToServer(entry){
        const payload = { action:'submitAssignment', payload: entry };
        try {
          const r = await fetch(GS_SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const txt = await r.text();
          console.log('GS response', txt);
        } catch(e){ console.warn('GS send failed', e); }
      }

      function insertSample(){
        if(window.codeEditor && window.codeEditor.state){ try { const view = window.codeEditor; view.dispatch({ changes: { from:0, to: view.state.doc.length, insert: ASSIGNMENT.sample } }); view.focus(); } catch(e){} }
        else { const ta = document.getElementById('assignmentEditorFallback'); if(ta) ta.value = ASSIGNMENT.sample; }
      }

      function showAlreadySubmitted(){
        document.getElementById('studentDetailsCard').classList.add('d-none');
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.remove('d-none');
      }

      function showAdminView(){
        const modal = document.getElementById('adminModal');
        const body = document.getElementById('adminModalBody');
        body.innerHTML = '';
        if(!submissions.length){ body.innerHTML = '<div class="text-muted">No submissions yet.</div>'; modal.style.display='block'; return; }
        const table = document.createElement('table'); table.className='table table-sm';
        table.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>Mobile</th><th>Score</th><th>Submitted At</th><th>Query</th></tr></thead>`;
        const tb = document.createElement('tbody');
        submissions.forEach((r, i)=> {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.mobile)}</td><td>${r.score}</td><td>${new Date(r.submittedAt).toLocaleString()}</td><td><pre style="white-space:pre-wrap">${escapeHtml(r.query)}</pre></td>`;
          tb.appendChild(tr);
        });
        table.appendChild(tb); body.appendChild(table); modal.style.display='block';
      }

      function exportCSV(){
        if(!submissions.length){ alert('No submissions to export'); return; }
        const rows=[['assignmentId','name','mobile','score','submittedAt','query']];
        submissions.forEach(r => rows.push([r.assignmentId, r.name, r.mobile, r.score, r.submittedAt, r.query.replace(/\n/g,' ')]));
        const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'submissions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"'`=\/]/g, ch => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[ch]); }

      return { init, start, submit, insertSample, cancel, clearStudentDetails, hasSubmitted, showAlreadySubmitted, showAdminView, exportCSV };
    })();

    // init on load
    window.addEventListener('load', function(){
      AssignmentModule.init();
      document.getElementById('adminModal').addEventListener('click', function(e){ if(e.target===this) this.style.display='none'; });
      window.AssignmentModule = AssignmentModule;
    });
  </script>
</body>
</html>
