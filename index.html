<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Practice Session Notes + Assignments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
    .weekday { font-weight: 600; text-align: center; color: #495057; padding: 6px 0; background: #f8f9fa; border-radius: 0.5rem; border: 1px solid #e9ecef; }
    .calendar-day { border: 1px solid #dee2e6; padding: 12px; text-align: center; cursor: pointer; min-height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 0.6rem; background-color: #ffffff; transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease; font-weight: 500; }
    .calendar-day.has-notes { background: linear-gradient(135deg, #d1e7dd, #b6e0c2); color: #0f5132; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25); border-color: #b6e0c2; }
    .calendar-day.today { background: linear-gradient(135deg, #fff3cd, #ffe69c); color: #664d03; border-color: #ffe69c; box-shadow: 0 3px 10px rgba(255, 193, 7, 0.25); font-weight: 700; }
    .calendar-day:hover { transform: translateY(-2px); background: linear-gradient(135deg, #f8d7da, #f5c2c7); color: #842029; box-shadow: 0 6px 16px rgba(220, 53, 69, 0.25); border-color: #f5c2c7; }
    .month-header { background: linear-gradient(90deg, #0d6efd, #6610f2); }
    #calendarContainer .card { border: none; overflow: hidden; }
    @media (max-width: 576px) {
      .calendar { grid-template-columns: repeat(3, 1fr); }
      .weekday { font-size: 0.8rem; padding: 4px 0; }
      .calendar-day { min-height: 52px; font-size: 0.9rem; padding: 8px; }
      .btn { width: 100%; }
      .nav-controls h4 { font-size: 1rem; margin: 0 8px; }
    }
    /* Assignment styles */
    #assignmentSection { margin: 32px 0; }
    #aceEditor { height: 250px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; z-index:1050; display:none; background: rgba(0,0,0,0.4); }
    .modal .modal-dialog { margin: 6rem auto; }
    .text-truncate-multi { overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container d-flex align-items-center">
      <span class="navbar-brand">Practice Session Notes</span>
      <!-- Assignments button -->
      <button id="openAssignmentsBtn" class="btn btn-warning ms-3" onclick="document.getElementById('assignmentSection').scrollIntoView({behavior:'smooth'})">Assignments</button>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <!-- Admin View Button -->
        <button id="adminViewBtn" class="btn btn-outline-light" onclick="AssignmentModule.showAdminView()">Admin View</button>
      </div>
    </div>
  </nav>

  <div id="latestNotification" class="alert alert-info text-center mb-0">Latest notes: Loading‚Ä¶</div>

  <main class="container py-4">
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" onclick="downloadSQLFile('Afternoon','Afternoon.sql')">Download Afternoon Notes</button>
      <button class="btn btn-primary" onclick="downloadSQLFile('Evening','Evening.sql')">Download Evening Notes</button>
    </div>

    <!-- Navigation arrows -->
    <div class="nav-controls d-flex justify-content-between align-items-center mb-2">
      <button class="btn btn-outline-secondary" onclick="prevMonth()">‚Üê Previous</button>
      <h4 id="monthLabel" class="fw-bold mb-0"></h4>
      <button class="btn btn-outline-secondary" onclick="nextMonth()">Next ‚Üí</button>
    </div>

    <div id="calendarContainer" class="mb-4"></div>

    <div id="notesContainer"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <h5>No notes yet</h5>
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-outline-secondary d-none" id="clearViewBtn" onclick="clearNotesView()">Clear View</button>
    </div>

    <!-- ===== ASSIGNMENT SECTION (ADDED) ===== -->
    <hr class="my-4">
    <section id="assignmentSection">
      <h3>SQL Assignment</h3>

      <!-- Student details capture -->
      <div id="studentDetailsCard" class="card p-3 mb-3">
        <h5 class="mb-2">Enter your details before starting</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <input id="studentName" class="form-control" placeholder="Full name">
          </div>
          <div class="col-md-6">
            <input id="studentMobile" class="form-control" placeholder="Mobile number">
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button id="startAssignmentBtn" class="btn btn-primary" onclick="AssignmentModule.start()">Start Assignment</button>
          <button id="clearStudentBtn" class="btn btn-outline-secondary" onclick="AssignmentModule.clearStudentDetails()">Clear</button>
        </div>
        <div class="form-text mt-2 text-muted">Students must fill details. After submitting, you cannot re-attempt (per browser).</div>
      </div>

      <!-- Assignment content -->
      <div id="assignmentCard" class="card mb-3 d-none">
        <div class="card-body">
          <div id="assignmentTitle" class="h5"></div>
          <div id="assignmentQuestion" class="mb-3 text-muted"></div>

          <label class="form-label">SQL Editor</label>
          <div id="aceEditor"></div>

          <div class="mt-3 d-flex gap-2">
            <button id="submitAssignmentBtn" class="btn btn-success" onclick="AssignmentModule.submit()">Submit</button>
            <button id="showSampleBtn" class="btn btn-outline-info" onclick="AssignmentModule.insertSample()">Show Sample</button>
            <button id="cancelAssignmentBtn" class="btn btn-outline-secondary" onclick="AssignmentModule.cancel()">Cancel</button>
          </div>

          <div id="assignmentResult" class="mt-3"></div>
        </div>
      </div>

      <!-- Already submitted -->
      <div id="alreadySubmittedCard" class="alert alert-success d-none">
        You have already submitted this assignment. Thank you!
      </div>
    </section>
    <!-- ===== end assignment section ===== -->

  </main>

  <!-- Admin modal -->
  <div id="adminModal" class="modal" role="dialog">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header d-flex justify-content-between align-items-center">
          <h5 class="modal-title">Submissions (Admin)</h5>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="AssignmentModule.exportCSV()">Export CSV</button>
            <button class="btn btn-sm btn-secondary" onclick="document.getElementById('adminModal').style.display='none'">Close</button>
          </div>
        </div>
        <div class="modal-body" id="adminModalBody">
          <!-- Filled dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Ace editor CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.9.15/ace.js"></script>

  <script>
    /* ---------------------------
       ORIGINAL NOTES & CALENDAR
       (unchanged, copied from your original)
       --------------------------- */
    let allNotes = [];
    let currentMonthIndex, currentYear;

    const monthMap = {
      JAN: "01", FEB: "02", MAR: "03", APR: "04", MAY: "05", JUN: "06",
      JUL: "07", AUG: "08", SEP: "09", OCT: "10", NOV: "11", DEC: "12"
    };
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    function parseNoteDate(str) {
      const [d, mText, y] = str.split("-");
      const mNum = Number(monthMap[mText.toUpperCase()]);
      return { day: d, monthNum: mNum, monthText: mText.toUpperCase(), year: y };
    }

    function toJSDate(str) {
      const { day, monthNum, year } = parseNoteDate(str);
      return new Date(Number(year), monthNum - 1, Number(day));
    }

    async function loadNotes() {
      try {
        const res = await fetch("notes.json");
        const notes = await res.json();
        allNotes = notes;

        const today = new Date();
        currentMonthIndex = today.getMonth();
        currentYear = today.getFullYear();

        renderCalendar();
        updateLatestNotification();
      } catch (err) {
        console.error("Error loading notes:", err);
        document.getElementById("latestNotification").textContent = "Failed to load notes.";
      }
    }

    function renderCalendar() {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      document.getElementById("monthLabel").textContent = `${monthNames[currentMonthIndex]} ${currentYear}`;

      const daysInMonth = new Date(currentYear, currentMonthIndex + 1, 0).getDate();
      let firstDay = new Date(currentYear, currentMonthIndex, 1).getDay();
      firstDay = firstDay === 0 ? 7 : firstDay;

      const card = document.createElement("div");
      card.className = "card shadow-lg";

      const calendarBody = document.createElement("div");
      calendarBody.className = "card-body";

      const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
      const weekdayRow = document.createElement("div");
      weekdayRow.className = "calendar";
      weekdays.forEach(w => {
        const wd = document.createElement("div");
        wd.className = "weekday";
        wd.textContent = w;
        weekdayRow.appendChild(wd);
      });
      calendarBody.appendChild(weekdayRow);

      const calendar = document.createElement("div");
      calendar.className = "calendar";

      for (let i = 1; i < firstDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.className = "calendar-day";
        calendar.appendChild(emptyCell);
      }

      const today = new Date();
      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");

        const hasNote = allNotes.some(n => {
          const { day, monthNum, year } = parseNoteDate(n.date);
          return day === dayStr && monthNum === currentMonthIndex + 1 && Number(year) === currentYear;
        });

        const dayCell = document.createElement("div");
        dayCell.className = "calendar-day" + (hasNote ? " has-notes" : "");
        dayCell.textContent = d;

        if (today.getMonth() === currentMonthIndex && today.getFullYear() === currentYear && today.getDate() === d) {
          dayCell.classList.add("today");
        }

        dayCell.addEventListener("click", () => {
          const filtered = allNotes.filter(n => {
            const { day, monthNum, year } = parseNoteDate(n.date);
            return day === dayStr && monthNum === currentMonthIndex + 1 && Number(year) === currentYear;
          });
          renderNotes(filtered);
        });

        calendar.appendChild(dayCell);
      }

      const totalCells = (firstDay - 1) + daysInMonth;
      const trailing = (7 - (totalCells % 7)) % 7;
      for (let i = 0; i < trailing; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.className = "calendar-day";
        calendar.appendChild(emptyCell);
      }

      calendarBody.appendChild(calendar);
      card.appendChild(calendarBody);
      container.appendChild(card);
    }

    function prevMonth() {
      currentMonthIndex--;
      if (currentMonthIndex < 0) {
        currentMonthIndex = 11;
        currentYear--;
      }
      renderCalendar();
    }

    function nextMonth() {
      currentMonthIndex++;
      if (currentMonthIndex > 11) {
        currentMonthIndex = 0;
        currentYear++;
      }
      renderCalendar();
    }

    function renderNotes(notes) {
      const container = document.getElementById("notesContainer");
      const emptyState = document.getElementById("emptyState");
      const clearBtn = document.getElementById("clearViewBtn");
      container.innerHTML = "";

      if (!notes.length) {
        emptyState.classList.remove("d-none");
        clearBtn.classList.add("d-none");
        return;
      }
      emptyState.classList.add("d-none");

      notes.forEach(n => {
        const card = document.createElement("div");
        card.className = "card mb-3 shadow-sm";
        card.innerHTML = `
          <div class="card-header bg-success text-white">
            <strong>${n.date}</strong> ‚Äì ${n.session} ‚Äì ${n.title}
          </div>
          <div class="card-body">
            <pre class="bg-light p-3 rounded"><code>${n.body}</code></pre>
          </div>
        `;
        container.appendChild(card);
      });

      clearBtn.classList.remove("d-none");
    }

    function clearNotesView() {
      document.getElementById("notesContainer").innerHTML = "";
      document.getElementById("emptyState").classList.add("d-none");
      document.getElementById("clearViewBtn").classList.add("d-none");
    }

    function downloadSQLFile(session, filename) {
      const sessionNotes = allNotes.filter(n => n.session === session);
      const sqlContent = sessionNotes
        .map(n => `-- ${n.date} : ${n.title}\n${n.body}\n\n`)
        .join("");
      const blob = new Blob([sqlContent], { type: "text/sql" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
      showNotification(`${filename} has been updated and downloaded!`);
    }

    function showNotification(message) {
      const notif = document.createElement("div");
      notif.className = "alert alert-success text-center";
      notif.textContent = message;
      document.body.prepend(notif);
      setTimeout(() => notif.remove(), 5000);
    }

    function updateLatestNotification() {
      if (!allNotes.length) {
        document.getElementById("latestNotification").textContent = "No notes available yet.";
        return;
      }
      const sorted = [...allNotes].sort((a, b) => toJSDate(b.date) - toJSDate(a.date));
      const latestDate = sorted[0].date;
      const latestDayNotes = allNotes.filter(n => n.date === latestDate);
      const latestNote = latestDayNotes.find(n => n.session === "Evening") || latestDayNotes[0];

      document.getElementById("latestNotification").textContent =
        `üîî Latest notes available: ${latestNote.date} (${latestNote.session} session, uploaded at ${latestNote.time})`;
    }

    // Boot original notes
    loadNotes();

    /* ---------------------------
       ASSIGNMENT MODULE
       - preserves original functionality
       - uses Ace editor for SQL input
       - uses localStorage for submissions
       - optional Google Apps Script endpoint push (set GS_SCRIPT_URL)
       --------------------------- */
    const AssignmentModule = (function(){
      // Config: put your Google Apps Script Web App URL here to send submissions to Google Sheets.
      // Example: const GS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfy.../exec';
      // If left blank, module will only use localStorage.
      const GS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzShbVFdlHdtM9mQ0DbRR7zvEPvgwzuY7lYUSpiDs-Ak4RJ3gWaJzIVDbdVP8m4TduwEA/exec'; // <-- put your Apps Script URL here (leave empty to use local only)

      const STORAGE_KEY_SUBMISSIONS = 'assign_submissions_v1';
      const STORAGE_KEY_STUDENT = 'assign_student_v1';
      const ASSIGNMENT = {
        id: 1,
        title: 'SQL Basics Assignment',
        question: `1) Create table EMP (ID INT, NAME TEXT, SALARY INT)\n2) Insert at least 3 rows\n3) Write a SELECT query to fetch employees with SALARY > 5000`,
        sample: `-- Example sample (not executed here)\nSELECT * FROM EMP WHERE SALARY > 5000;`,
        // No auto SQL execution engine here; we do keyword-based grading.
      };

      let editor = null;
      let submissions = []; // array of { name, mobile, query, score, time }

      function init(){
        // load submissions
        try { submissions = JSON.parse(localStorage.getItem(STORAGE_KEY_SUBMISSIONS) || '[]'); } catch(e){ submissions = []; }
        // load student info (if already entered)
        const savedStudent = JSON.parse(localStorage.getItem(STORAGE_KEY_STUDENT) || 'null');
        if(savedStudent && savedStudent.name){
          document.getElementById('studentName').value = savedStudent.name || '';
          document.getElementById('studentMobile').value = savedStudent.mobile || '';
          // if the saved student already submitted, show submitted state
          if(hasSubmitted(savedStudent)){
            showAlreadySubmitted();
          }
        }
        // init Ace editor after DOM ready
      //  setTimeout(()=>{ initAce(); }, 200);
      }

      // function initAce(){
      //   try {
      //     editor = ace.edit('aceEditor', { mode: 'ace/mode/sql', theme: 'ace/theme/sqlserver' });
      //     editor.session.setUseWrapMode(true);
      //     editor.setValue(ASSIGNMENT.sample, -1);
      //   } catch (e){
      //     console.warn('Ace init failed', e);
      //   }
      // }
function initAce(){
  if(!editor){
    editor = ace.edit("aceEditor");
    editor.session.setMode("ace/mode/sql");
    editor.setTheme("ace/theme/sqlserver");
    editor.session.setUseWrapMode(true);
  }

  editor.setValue(ASSIGNMENT.sample, -1);

  // Force resize and focus
  editor.resize();
  editor.focus();
}



      // function start(){
      //   const name = document.getElementById('studentName').value.trim();
      //   const mobile = document.getElementById('studentMobile').value.trim();
      //   if(!name || !mobile){
      //     alert('Please enter name and mobile number before starting the assignment.');
      //     return;
      //   }
      //   const student = { name, mobile };
      //   localStorage.setItem(STORAGE_KEY_STUDENT, JSON.stringify(student));
      //   // check if this student already submitted
      //   if(hasSubmitted(student)){
      //     showAlreadySubmitted();
      //     return;
      //   }
      //   // show assignment UI
      //   document.getElementById('studentDetailsCard').classList.add('d-none');
      //   document.getElementById('assignmentCard').classList.remove('d-none');
      //   document.getElementById('assignmentTitle').textContent = ASSIGNMENT.title;
      //   document.getElementById('assignmentQuestion').textContent = ASSIGNMENT.question;
      //   document.getElementById('assignmentResult').innerHTML = '';

      //   initAce();
      // }

      function start() {
  const name = document.getElementById('studentName').value.trim();
  const mobile = document.getElementById('studentMobile').value.trim();
  if(!name || !mobile){
    alert('Please enter name and mobile number before starting the assignment.');
    return;
  }

  const student = { name, mobile };
  localStorage.setItem(STORAGE_KEY_STUDENT, JSON.stringify(student));

  if(hasSubmitted(student)){
    showAlreadySubmitted();
    return;
  }

  // Show assignment UI
  document.getElementById('studentDetailsCard').classList.add('d-none');
  document.getElementById('assignmentCard').classList.remove('d-none');
  document.getElementById('assignmentTitle').textContent = ASSIGNMENT.title;
  document.getElementById('assignmentQuestion').textContent = ASSIGNMENT.question;
  document.getElementById('assignmentResult').innerHTML = '';

  // Initialize Ace AFTER card is visible
  setTimeout(() => {
    initAce();
  }, 100); // slight delay ensures div is rendered
}


      function cancel(){
        // go back to details capture
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('studentDetailsCard').classList.remove('d-none');
      }

      function clearStudentDetails(){
        localStorage.removeItem(STORAGE_KEY_STUDENT);
        document.getElementById('studentName').value = '';
        document.getElementById('studentMobile').value = '';
        if(editor) editor.setValue(ASSIGNMENT.sample, -1);
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.add('d-none');
        document.getElementById('studentDetailsCard').classList.remove('d-none');
      }

      function hasSubmitted(student){
        if(!student) return false;
        return submissions.some(s => s.name === student.name && s.mobile === student.mobile && s.assignmentId === ASSIGNMENT.id);
      }

      function showAlreadySubmitted(){
        document.getElementById('studentDetailsCard').classList.add('d-none');
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.remove('d-none');
      }

      function gradeQuery(query){
        // Basic heuristic scoring out of 100:
        // SELECT => 30, FROM => 20, WHERE => 20, CREATE => 15, INSERT => 15
        let score = 0;
        const q = query.toLowerCase();
        if(q.includes('select')) score += 30;
        if(q.includes('from')) score += 20;
        if(q.includes('where')) score += 20;
        if(q.includes('create')) score += 15;
        if(q.includes('insert')) score += 15;
        if(score > 100) score = 100;
        return score;
      }

      async function submit(){
        const student = JSON.parse(localStorage.getItem(STORAGE_KEY_STUDENT) || 'null');
        if(!student || !student.name) { alert('Provide your details first'); return; }
        // prevent double submit for same browser/student
        if(hasSubmitted(student)){
          alert('You have already submitted this assignment.');
          showAlreadySubmitted();
          return;
        }
        const query = editor ? editor.getValue().trim() : document.getElementById('assignmentEditorFallback') ? document.getElementById('assignmentEditorFallback').value.trim() : '';
        if(!query){
          alert('Please write your SQL before submitting.');
          return;
        }
        const score = gradeQuery(query);
        const entry = {
          assignmentId: ASSIGNMENT.id,
          name: student.name,
          mobile: student.mobile,
          query,
          score,
          submittedAt: new Date().toISOString()
        };
        submissions.unshift(entry);
        localStorage.setItem(STORAGE_KEY_SUBMISSIONS, JSON.stringify(submissions));
        // reflect submission UI
        document.getElementById('assignmentResult').innerHTML = `<div class="alert alert-info">Submitted! Score: <strong>${score}</strong>/100</div>`;
        document.getElementById('assignmentCard').classList.add('d-none');
        document.getElementById('alreadySubmittedCard').classList.remove('d-none');
        // attempt to send to Google Sheets if configured
        if(GS_SCRIPT_URL && GS_SCRIPT_URL.trim()){
          try {
            await sendToServer(entry);
          } catch (e){
            console.warn('Send to server failed', e);
          }
        }
      }

      async function sendToServer(entry){
        // POST JSON to the Apps Script endpoint (you must implement doPost in Apps Script to accept this)
        // Payload structure: { action: 'submitAssignment', payload: entry }
        const payload = { action: 'submitAssignment', payload: entry };
        try {
          const res = await fetch(GS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await res.text();
          // Not mandatory to parse response; Apps Script can return simple text
          console.log('GS response:', text);
        } catch (e){
          console.warn('Failed to send to Google Apps Script', e);
        }
      }

      function insertSample(){
        if(editor) editor.setValue(ASSIGNMENT.sample, -1);
      }

      // ADMIN VIEW - shows local submissions in modal
      function showAdminView(){
        const modal = document.getElementById('adminModal');
        const body = document.getElementById('adminModalBody');
        body.innerHTML = '';
        const data = submissions.slice(); // copy
        if(!data.length){
          body.innerHTML = '<div class="text-muted">No submissions yet.</div>';
        } else {
          const table = document.createElement('table');
          table.className = 'table table-sm';
          table.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>Mobile</th><th>Score</th><th>Submitted At</th><th>Query</th></tr></thead>`;
          const tb = document.createElement('tbody');
          data.forEach((r, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.mobile)}</td><td>${r.score}</td><td>${new Date(r.submittedAt).toLocaleString()}</td><td><pre style="white-space:pre-wrap">${escapeHtml(r.query)}</pre></td>`;
            tb.appendChild(tr);
          });
          table.appendChild(tb);
          body.appendChild(table);
        }
        modal.style.display = 'block';
      }

      function exportCSV(){
        const data = submissions.slice();
        if(!data.length){ alert('No submissions to export'); return; }
        const rows = [['assignmentId','name','mobile','score','submittedAt','query']];
        data.forEach(r => rows.push([r.assignmentId, r.name, r.mobile, r.score, r.submittedAt, r.query.replace(/\n/g,' ')]));
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'submissions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // minimal escape helper
      function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"'`=\/]/g, function(ch){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch]; }); }

      // expose public API
      return {
        init, start, submit, insertSample, cancel, clearStudentDetails, showAdminView, exportCSV
      };
    })();

    // Initialize assignment module after page load
    window.addEventListener('load', function(){
      AssignmentModule.init();
      // Admin modal close on outside click
      document.getElementById('adminModal').addEventListener('click', function(e){
        if(e.target === this) this.style.display = 'none';
      });
    });

    // Expose admin modal button
    window.AssignmentModule = AssignmentModule;
  </script>
</body>
</html>
