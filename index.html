<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Assignment Editor — Practice Session Notes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7fbff }
    pre { white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    .editor { height: 260px; font-family: monospace; }
    table.results td, table.results th { vertical-align: middle; }
    .small-muted { font-size:0.85rem; color:#6c757d }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
      <span class="navbar-brand">Practice Session Notes — SQL Assignment Editor</span>
      <button class="btn btn-sm btn-outline-light" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </nav>

  <main class="container py-4">
    <div id="app">
      <!-- Login -->
      <div id="loginView" class="card mx-auto" style="max-width:540px">
        <div class="card-body">
          <h5 class="card-title">Student login</h5>
          <p class="small-muted">Enter any username to join. This demo stores session locally (no server). For production you need a backend.</p>
          <div class="mb-3">
            <input id="username" class="form-control" placeholder="Your name / roll no" />
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" id="loginBtn">Join</button>
            <button class="btn btn-outline-secondary" id="demoBtn">Try demo student</button>
          </div>
        </div>
      </div>

      <!-- Assignment list -->
      <div id="assignmentView" style="display:none">
        <div class="row">
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-body">
                <h5>Welcome, <span id="displayName"></span></h5>
                <p class="small-muted">Select an assignment to start. You can run queries against the in-memory database. Your answers are auto-graded by comparing results.</p>
                <hr />
                <h6>Assignments</h6>
                <div id="assignmentList" class="list-group"></div>
                <hr />
                <button class="btn btn-sm btn-outline-secondary mt-2" id="viewResultsBtn">View my past results</button>
              </div>
            </div>
            <div class="card">
              <div class="card-body">
                <h6>Instructions</h6>
                <ol class="small-muted">
                  <li>Click an assignment → loads DB schema & test data.</li>
                  <li>Write SQL in the editor and click <strong>Run</strong>.</li>
                  <li>Click <strong>Submit Answer</strong> to lock result for the question.</li>
                  <li>At the end click <strong>Finish Test</strong> to see your score.</li>
                </ol>
              </div>
            </div>
          </div>

          <div class="col-md-8">
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <strong id="assignmentTitle">No assignment selected</strong>
                  <div class="small-muted" id="assignmentMeta"></div>
                </div>
                <div>
                  <button id="resetDbBtn" class="btn btn-sm btn-outline-secondary me-1" title="Reload DB for this assignment">Reset DB</button>
                  <button id="finishBtn" class="btn btn-success btn-sm">Finish Test</button>
                </div>
              </div>

              <div class="card-body">
                <div class="mb-2">
                  <label class="form-label">Database preview (tables)</label>
                  <div id="schemaPreview" class="small-muted border rounded p-2 mb-2" style="max-height:120px;overflow:auto;background:#fff"></div>
                </div>

                <label class="form-label">SQL Editor</label>
                <textarea id="sqlEditor" class="form-control editor" placeholder="Write your SQL here..."></textarea>

                <div class="mt-2 d-flex gap-2">
                  <button id="runBtn" class="btn btn-primary">Run</button>
                  <button id="submitBtn" class="btn btn-outline-primary">Submit Answer</button>
                  <button id="downloadBtn" class="btn btn-outline-secondary">Download Results</button>
                </div>

                <div id="runOutput" class="mt-3"></div>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h6>Grading / Status</h6>
                <div id="gradingStatus" class="small-muted">No submissions yet.</div>
                <div id="detailedResults" class="mt-3"></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Results history modal-like area -->
      <div id="historyView" style="display:none">
        <div class="card">
          <div class="card-body">
            <h5>Past results for <span id="historyName"></span></h5>
            <div id="historyList"></div>
            <div class="mt-3">
              <button class="btn btn-secondary" id="backToAssignments">Back</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="https://sql.js.org/dist/sql-wasm.js"></script>
  <script>
    // ----- Demo assignments (simple) -----
    const ASSIGNMENTS = [
      {
        id: 'A1',
        title: 'Simple SELECT and JOIN',
        description: 'Return customer name and city for orders with total > 50',
        // tables: schema + inserts for initializing sqlite DB
        schema: [
          `CREATE TABLE customers(id INTEGER PRIMARY KEY, name TEXT, city TEXT);`,
          `CREATE TABLE orders(id INTEGER PRIMARY KEY, customer_id INTEGER, total NUMERIC, created DATE);`,
          `INSERT INTO customers VALUES(1,'Alice','Mumbai'),(2,'Bob','Delhi'),(3,'Charlie','Bengaluru');`,
          `INSERT INTO orders VALUES(1,1,45,'2025-12-01'),(2,2,75,'2025-12-02'),(3,1,60,'2025-12-03');`
        ],
        // expected result rows (unordered)
        expected: [{name:'Bob', city:'Delhi'},{name:'Alice', city:'Mumbai'}]
      },

      {
        id: 'A2',
        title: 'Aggregation and GROUP BY',
        description: 'List product and total sold quantity > 10',
        schema: [
          `CREATE TABLE products(id INTEGER PRIMARY KEY, name TEXT);`,
          `CREATE TABLE sales(id INTEGER PRIMARY KEY, product_id INTEGER, qty INTEGER);`,
          `INSERT INTO products VALUES(1,'Pen'),(2,'Pencil'),(3,'Notebook');`,
          `INSERT INTO sales VALUES(1,1,5),(2,1,10),(3,2,3),(4,3,8),(5,1,1);`
        ],
        expected: [{name:'Pen', total:16}]
      }
    ];

    // ----- App state -----
    let SQL; // the initSqlJs module instance
    let db;  // current in-memory DB for the selected assignment
    let currentUser = null;
    let currentAssignment = null;
    const SUBMISSIONS_KEY = 'sql_assign_submissions_v1'; // localStorage key

    // Helpers for UI
    const el = id => document.getElementById(id);

    async function initSqlJsModule() {
      if (window.initSqlJs === undefined) throw new Error('sql.js not loaded');
      SQL = await initSqlJs({ locateFile: file => `https://sql.js.org/dist/${file}` });
    }

    function resetDBFromAssignment(a) {
      if (!a) return;
      if (!SQL) { alert('sql.js not ready'); return; }
      db = new SQL.Database();
      a.schema.forEach(s => db.run(s));
      renderSchemaPreview(a);
      showMessage('DB loaded for ' + a.id);
    }

    function renderSchemaPreview(a) {
      const div = el('schemaPreview');
      const tables = [];
      try {
        const rows = db.exec("SELECT name, type, sql FROM sqlite_master WHERE type IN ('table','view')");
        if (rows && rows[0]) {
          const cols = rows[0].columns; const values = rows[0].values;
          values.forEach(r => tables.push({name:r[0], sql:r[2]}));
        }
      } catch(e) {}
      div.innerHTML = tables.map(t => `<div><strong>${t.name}</strong><pre class="mb-0 small">${t.sql}</pre></div>`).join('<hr/>');
    }

    function populateAssignmentList() {
      const list = el('assignmentList'); list.innerHTML = '';
      ASSIGNMENTS.forEach(a => {
        const btn = document.createElement('button');
        btn.className = 'list-group-item list-group-item-action';
        btn.textContent = `${a.id} — ${a.title}`;
        btn.onclick = () => selectAssignment(a.id);
        list.appendChild(btn);
      });
    }

    function selectAssignment(id) {
      const a = ASSIGNMENTS.find(x => x.id === id);
      if (!a) return;
      currentAssignment = a;
      el('assignmentTitle').textContent = `${a.id} - ${a.title}`;
      el('assignmentMeta').textContent = a.description;
      resetDBFromAssignment(a);
      el('sqlEditor').value = '-- Write SQL that produces the expected result\n';
      el('runOutput').innerHTML = '';
      el('gradingStatus').textContent = 'Not submitted yet.';
      renderDetailedResults();
    }

    function runSQL() {
      const q = el('sqlEditor').value.trim();
      if (!q) return showMessage('Write a query first');
      try {
        const res = db.exec(q);
        if (!res || !res.length) {
          el('runOutput').innerHTML = '<div class="alert alert-warning">No rows returned.</div>';
          return null;
        }
        // render first resultset
        const r = res[0];
        const table = buildHtmlTable(r.columns, r.values);
        el('runOutput').innerHTML = `<div class="small-muted mb-2">Returned ${r.values.length} rows</div>` + table;
        return r;
      } catch (err) {
        el('runOutput').innerHTML = `<div class="alert alert-danger">Error: ${err.toString()}</div>`;
        return null;
      }
    }

    function buildHtmlTable(cols, values) {
      let html = '<div class="table-responsive"><table class="table table-sm table-bordered results"><thead><tr>';
      cols.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
      html += '</tr></thead><tbody>';
      values.forEach(row => {
        html += '<tr>' + row.map(cell => `<td>${escapeHtml(String(cell === null ? 'NULL' : cell))}</td>`).join('') + '</tr>';
      });
      html += '</tbody></table></div>';
      return html;
    }

    function escapeHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function compareResults(expected, actual) {
      // expected: array of objects with key:value
      // actual: {columns:[], values:[]}
      if (!actual) return false;
      const cols = actual.columns.map(c => c.toString());
      const rows = actual.values.map(r => {
        const obj = {}; cols.forEach((c,i) => { obj[c] = r[i]; });
        return obj;
      });
      // compare as unordered sets of JSON strings (normalize types to string)
      const norm = arr => arr.map(o => JSON.stringify(Object.keys(o).sort().reduce((acc,k)=>{acc[k]=String(o[k]);return acc;},{}))).sort();
      const eNorm = norm(expected);
      const aNorm = norm(rows);
      if (eNorm.length !== aNorm.length) return false;
      for (let i=0;i<eNorm.length;i++) if (eNorm[i] !== aNorm[i]) return false;
      return true;
    }

    function submitAnswer() {
      if (!currentAssignment) return showMessage('Select an assignment first');
      const runRes = runSQL();
      if (!runRes) return showMessage('Run a SELECT query that returns rows before submitting');
      const ok = compareResults(currentAssignment.expected, runRes);
      saveSubmission(currentUser, currentAssignment.id, el('sqlEditor').value, ok, runRes);
      el('gradingStatus').textContent = ok ? 'Correct ✅' : 'Incorrect ❌';
      renderDetailedResults();
      showMessage('Answer submitted.');
    }

    function saveSubmission(user, aid, sql, correct, runRes) {
      const all = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '[]');
      const rec = { user, aid, sql, correct, timestamp: new Date().toISOString(), result: runRes };
      all.push(rec);
      localStorage.setItem(SUBMISSIONS_KEY, JSON.stringify(all));
    }

    function loadUserSubmissions(user) {
      const all = JSON.parse(localStorage.getItem(SUBMISSIONS_KEY) || '[]');
      return all.filter(r => r.user === user);
    }

    function renderDetailedResults() {
      const area = el('detailedResults'); area.innerHTML = '';
      const subs = loadUserSubmissions(currentUser).filter(s=>s.aid === (currentAssignment?currentAssignment.id: null));
      if (!subs.length) return area.innerHTML = '<div class="small-muted">No submissions for this assignment yet.</div>';
      const list = subs.map(s => `<div class="mb-2"><strong>${new Date(s.timestamp).toLocaleString()}</strong> — ${s.correct?'<span class="text-success">Correct</span>':'<span class="text-danger">Incorrect</span>'}<pre class="mt-1 mb-0 small">${escapeHtml(s.sql)}</pre>${!s.correct ? `<div class='text-danger small mt-1'>Correct Answer: ${escapeHtml(JSON.stringify(currentAssignment.expected))}</div>` : ''}</div>`).join('');(s => `<div class="mb-2"><strong>${new Date(s.timestamp).toLocaleString()}</strong> — ${s.correct?'<span class="text-success">Correct</span>':'<span class="text-danger">Incorrect</span>'}<pre class="mt-1 mb-0 small">${escapeHtml(s.sql)}</pre></div>`).join('');
      area.innerHTML = list;
    }

    function showMessage(msg, ttl=3000) {
      const n = document.createElement('div'); n.className='alert alert-info'; n.textContent=msg;
      document.body.prepend(n); setTimeout(()=>n.remove(), ttl);
    }

    function finishTest() {
      // compute score across all assignments by latest submission per assignment
      const subs = loadUserSubmissions(currentUser);
      if (!subs.length) return showMessage('No submissions found.');
      const byAid = {};
      subs.forEach(s => { byAid[s.aid] = s; });
      const aids = Object.keys(byAid);
      let correct = 0; aids.forEach(aid=>{ if (byAid[aid].correct) correct++; });
      const score = Math.round((correct / ASSIGNMENTS.length) * 100);
      // show modal-like result
      const detail = aids.map(aid => `• ${aid}: ${byAid[aid].correct ? 'Correct' : 'Incorrect'}`).join('\n');
      el('gradingStatus').textContent = `Score: ${score}% (${correct}/${ASSIGNMENTS.length})`;
      el('detailedResults').innerHTML = `<pre>${escapeHtml(detail)}</pre>`;
      showMessage(`Test finished — Score ${score}%`);
    }

    function downloadResults() {
      const data = loadUserSubmissions(currentUser);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${currentUser || 'student'}-results.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showMessage('Results downloaded');
    }

    // Login flows
    function loginAs(name) {
      currentUser = name || ('student_' + Math.floor(Math.random()*1000));
      el('displayName').textContent = currentUser;
      el('loginView').style.display = 'none';
      el('assignmentView').style.display = '';
      el('logoutBtn').style.display = '';
      populateAssignmentList();
      // pre-init first assignment visually
      selectAssignment(ASSIGNMENTS[0].id);
    }

    function logout() {
      currentUser = null;
      el('loginView').style.display = '';
      el('assignmentView').style.display = 'none';
      el('logoutBtn').style.display = 'none';
    }

    // event bindings
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await initSqlJsModule();
      } catch(e) { alert('Failed to load sql.js: '+e); }

      el('loginBtn').onclick = () => {
        const u = el('username').value.trim(); if (!u) return showMessage('Enter username');
        loginAs(u);
      };
      el('demoBtn').onclick = () => loginAs('demo_student');
      el('logoutBtn').onclick = logout;
      el('runBtn').onclick = runSQL;
      el('submitBtn').onclick = submitAnswer;
      el('resetDbBtn').onclick = () => { if (currentAssignment) resetDBFromAssignment(currentAssignment); };
      el('finishBtn').onclick = finishTest;
      el('downloadBtn').onclick = downloadResults;
      el('viewResultsBtn').onclick = () => {
        el('assignmentView').style.display = 'none';
        el('historyView').style.display = '';
        el('historyName').textContent = currentUser;
        const h = loadUserSubmissions(currentUser);
        el('historyList').innerHTML = h.length? h.map(r=>`<div class="mb-2"><strong>${r.aid}</strong> — ${new Date(r.timestamp).toLocaleString()} — ${r.correct?'<span class="text-success">Correct</span>':'<span class="text-danger">Incorrect</span>'}</div>`).join('') : '<div class="small-muted">No results yet</div>';
      };
      el('backToAssignments').onclick = () => { el('historyView').style.display = 'none'; el('assignmentView').style.display = ''; };

      // small UX: allow Ctrl+Enter to run
      el('sqlEditor').addEventListener('keydown', (e)=>{ if (e.ctrlKey && e.key === 'Enter') runSQL(); });
    });

  </script>
</body>
</html>
