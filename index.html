<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Practice Session Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre {
      white-space: pre-wrap;   /* preserve formatting but allow wrapping */
      word-wrap: break-word;
      font-family: monospace;
    }
    .toggle-btn {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Practice Session Notes</span>
    </div>
  </nav>

  <!-- Persistent latest notes banner -->
  <div id="latestNotification" class="alert alert-info text-center mb-0">
    Latest notes: Loadingâ€¦
  </div>

  <main class="container py-4">
    <!-- Date filter -->
    <div class="mb-3 d-flex gap-2">
      <input type="date" id="filterDate" class="form-control" />
      <button class="btn btn-primary" onclick="applyFilter()">Filter</button>
      <button class="btn btn-secondary" onclick="resetFilter()">Reset</button>
    </div>

    <!-- Download buttons -->
    <div class="mb-3 d-flex gap-2">
      <button class="btn btn-success" onclick="downloadSQLFile('Afternoon','Afternoon.sql')">Download Afternoon Notes</button>
      <button class="btn btn-primary" onclick="downloadSQLFile('Evening','Evening.sql')">Download Evening Notes</button>
    </div>

    <div id="notesContainer"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <h5>No notes yet</h5>
    </div>
  </main>

  <script>
    let allNotes = [];

    async function loadNotes() {
      try {
        const res = await fetch("notes.json");
        const notes = await res.json();

        // Notify if new content added
        if (allNotes.length && notes.length > allNotes.length) {
          showNotification("ðŸ“¢ New content has been added to the notes!");
        }

        allNotes = notes;
        renderNotes(notes);
        updateLatestNotification(); // update persistent banner
      } catch (err) {
        console.error("Error loading notes:", err);
      }
    }

    function renderNotes(notes) {
      const container = document.getElementById("notesContainer");
      const emptyState = document.getElementById("emptyState");
      container.innerHTML = "";

      if (!notes.length) {
        emptyState.classList.remove("d-none");
        return;
      }
      emptyState.classList.add("d-none");

      // group by date
      const groups = {};
      notes.forEach(n => {
        groups[n.date] = groups[n.date] || [];
        groups[n.date].push(n);
      });

      Object.keys(groups).sort().forEach(date => {
        const list = groups[date];
        const card = document.createElement("div");
        card.className = "card mb-3";

        card.innerHTML = `
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>${date}</strong>
            <span class="toggle-btn text-primary">[+]</span>
          </div>
          <div class="list-group list-group-flush" style="display:none;">
            ${list.map(n => `
              <div class="list-group-item">
                <h6>${n.session} â€“ ${n.title}</h6>
                <pre class="bg-light p-3"><code>${n.body}</code></pre>
              </div>
            `).join("")}
          </div>
        `;

        // toggle collapse
        const toggleBtn = card.querySelector(".toggle-btn");
        const content = card.querySelector(".list-group");
        toggleBtn.addEventListener("click", () => {
          if (content.style.display === "none") {
            content.style.display = "block";
            toggleBtn.textContent = "[â€“]";
          } else {
            content.style.display = "none";
            toggleBtn.textContent = "[+]";
          }
        });

        container.appendChild(card);
      });
    }

    function applyFilter() {
      const filterDate = document.getElementById("filterDate").value;
      if (!filterDate) {
        renderNotes(allNotes);
        return;
      }

      // Convert YYYY-MM-DD â†’ DD-MMM-YYYY
      const d = new Date(filterDate);
      const day = String(d.getDate()).padStart(2, '0');
      const month = d.toLocaleString('en-US', { month: 'short' }).toUpperCase();
      const year = d.getFullYear();
      const formatted = `${day}-${month}-${year}`;

      const filtered = allNotes.filter(n => n.date === formatted);
      renderNotes(filtered);
    }

    function resetFilter() {
      document.getElementById("filterDate").value = "";
      renderNotes(allNotes);
    }

    // Download SQL file by session
    function downloadSQLFile(session, filename) {
      const sessionNotes = allNotes.filter(n => n.session === session);
      const sqlContent = sessionNotes.map(n => `-- ${n.date} : ${n.title}\n${n.body}\n\n`).join("");
      const blob = new Blob([sqlContent], { type: "text/sql" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);

      // Notify on download
      showNotification(`${filename} has been updated and downloaded!`);
    }

    // Temporary notification (auto-hide)
    function showNotification(message) {
      const notif = document.createElement("div");
      notif.className = "alert alert-success text-center";
      notif.textContent = message;
      document.body.prepend(notif);

      setTimeout(() => notif.remove(), 5000);
    }

    // Persistent latest notes banner
    function updateLatestNotification() {
      if (!allNotes.length) {
        document.getElementById("latestNotification").textContent = "No notes available yet.";
        return;
      }

      // Sort notes by date (newest first)
      const sorted = [...allNotes].sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // newest first
      });

      // Get all notes for the latest date
      const latestDate = sorted[0].date;
      const latestDayNotes = allNotes.filter(n => n.date === latestDate);

      // Prefer Evening if available, otherwise Afternoon
      let latestNote = latestDayNotes.find(n => n.session === "Evening") || latestDayNotes[0];

      // Show date, session, and time
      document.getElementById("latestNotification").textContent =
        `ðŸ“¢ Latest notes available: ${latestNote.date} (${latestNote.session} session, uploaded at ${latestNote.time})`;
    }

    loadNotes();
  </script>
</body>
</html>
