<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Practice Session Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: monospace;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 20px;
    }
    .weekday {
      font-weight: 600;
      text-align: center;
      color: #495057;
      padding: 6px 0;
      background: #f8f9fa;
      border-radius: 0.25rem;
      border: 1px solid #e9ecef;
    }
    .calendar-day {
      border: 1px solid #dee2e6;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: all 0.2s ease;
      background-color: #fff;
    }
    .calendar-day.has-notes {
      background-color: #d1e7dd;
      font-weight: bold;
      border-color: #b6e0c2;
    }
    .calendar-day.today {
      background-color: #fff3cd;
      border-color: #ffe69c;
      font-weight: 700;
    }
    .calendar-day.latest-update {
      background-color: #cfe2ff;
      border-color: #9ec5fe;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(13,110,253,0.2);
    }
    .calendar-day:hover {
      background-color: #f8d7da;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(220,53,69,0.15);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Practice Session Notes</span>
    </div>
  </nav>

  <div id="latestNotification" class="alert alert-info text-center mb-0">
    Latest notes: Loading…
  </div>

  <main class="container py-4">
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-success" onclick="downloadSQLFile('Afternoon','Afternoon.sql')">Download Afternoon Notes</button>
      <button class="btn btn-primary" onclick="downloadSQLFile('Evening','Evening.sql')">Download Evening Notes</button>
    </div>

    <div id="calendarContainer" class="mb-4"></div>

    <div id="notesContainer"></div>
    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <h5>No notes yet</h5>
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-outline-secondary d-none" id="clearViewBtn" onclick="clearNotesView()">Clear View</button>
    </div>
  </main>

  <script>
    let allNotes = [];

    function parseDDMMYYYY(str) {
      const [dd, mm, yyyy] = str.split("-");
      return new Date(Number(yyyy), Number(mm) - 1, Number(dd));
    }

    function getDaysInMonth(mm, yyyy) {
      return new Date(yyyy, mm, 0).getDate();
    }

    async function loadNotes() {
      try {
        const res = await fetch("notes.json");
        const notes = await res.json();
        allNotes = Array.isArray(notes) ? notes : [];
        renderCalendar(allNotes);
        updateLatestNotification();
      } catch (err) {
        console.error("Error loading notes:", err);
      }
    }

    function renderCalendar(notes) {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";

      const groups = {};
      notes.forEach(n => {
        const [dd, mm, yyyy] = n.date.split("-");
        const key = `${mm}-${yyyy}`;
        (groups[key] ||= []).push(n);
      });

      if (!Object.keys(groups).length) {
        const now = new Date();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const yyyy = String(now.getFullYear());
        groups[`${mm}-${yyyy}`] = [];
      }

      const latestDateStr = notes.length
        ? [...notes].sort((a, b) => parseDDMMYYYY(b.date) - parseDDMMYYYY(a.date))[0].date
        : null;

      const today = new Date();
      const tDD = String(today.getDate()).padStart(2, "0");
      const tMM = String(today.getMonth() + 1).padStart(2, "0");
      const tYYYY = String(today.getFullYear());

      const row = document.createElement("div");
      row.className = "row";

      Object.keys(groups).forEach(monthYear => {
        const [mm, yyyy] = monthYear.split("-");
        const monthNotes = groups[monthYear];

        const col = document.createElement("div");
        col.className = "col-md-6 mb-4";

        const card = document.createElement("div");
        card.className = "card shadow-sm";

        const header = document.createElement("div");
        header.className = "card-header bg-primary text-white fw-bold";
        header.textContent = monthYear;
        card.appendChild(header);

        const body = document.createElement("div");
        body.className = "card-body";

        const weekdayRow = document.createElement("div");
        weekdayRow.className = "calendar";
        ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(w => {
          const wd = document.createElement("div");
          wd.className = "weekday";
          wd.textContent = w;
          weekdayRow.appendChild(wd);
        });
        body.appendChild(weekdayRow);

        const calendar = document.createElement("div");
        calendar.className = "calendar";

        const daysInMonth = getDaysInMonth(Number(mm), Number(yyyy));
        for (let d = 1; d <= daysInMonth; d++) {
          const ddStr = String(d).padStart(2, "0");
          const dayCell = document.createElement("div");
          let classes = "calendar-day";

          const dayNotes = monthNotes.filter(n => n.date.startsWith(ddStr + "-"));
          if (dayNotes.length) classes += " has-notes";

          if (mm === tMM && yyyy === tYYYY && ddStr === tDD) {
            classes += " today";
          }

          if (latestDateStr) {
            const [ldd, lmm, lyr] = latestDateStr.split("-");
            if (ldd === ddStr && lmm === mm && lyr === yyyy) {
              classes += " latest-update";
            }
          }

          dayCell.className = classes;
          dayCell.textContent = d;

          if (dayNotes.length) {
            dayCell.title = dayNotes.map(n => `${n.session}: ${n.title}`).join(" | ");
            dayCell.addEventListener("click", () => renderNotes(dayNotes));
          }

          calendar.appendChild(dayCell);
        }

        body.appendChild(calendar);
        card.appendChild(body);
        col.appendChild(card);
        row.appendChild(col);
      });

      container.appendChild(row);
    }

    function renderNotes(notes) {
      const container = document.getElementById("notesContainer");
      const emptyState = document.getElementById("emptyState");
      const clearBtn = document.getElementById("clearViewBtn");
      container.innerHTML = "";

      if (!notes.length) {
        emptyState.classList.remove("d-none");
        clearBtn.classList.add("d-none");
        return;
      }
      emptyState.classList.add("d-none");

      notes.forEach(n => {
        const card = document.createElement("div");
        card.className = "card mb-3 shadow-sm";
        card.innerHTML = `
          <div class="card-header bg-success text-white">
            <strong>${n.date}</strong> – ${n.session} – ${n.title}
          </div>
          <div class="card-body">
            <pre class="bg-light p-3 rounded"><code>${n.body}</code></pre>
          </div>
        `;
        container.appendChild(card);
      });

      clearBtn.classList.remove("d-none");
    }

    function clearNotesView() {
      document.getElementById("notesContainer").innerHTML = "";
      document.getElementById("emptyState").classList.add("d-none");
      document.getElementById("clearViewBtn").classList.add("d-none");
    }

